<!DOCTYPE html>
<html>
<head>
<script>
  var heroes_json = {}
  let enemies = []
  let queryText = ""

  // Loading data function + helper

  function getHeroName(heroName) { // for dota.com avatars
    if (heroName == "anti-mage") return "antimage"
    else if (heroName == "centaur-warrunner") return "centaur"
    else if (heroName == "clockwerk") return "rattletrap"
    else if (heroName == "doom") return "doom_bringer"
    else if (heroName == "lifestealer") return "life_stealer"
    else if (heroName == "magnus") return "magnataur"
    else if (heroName == "natures-prophet") return "furion"
    else if (heroName == "magnus") return "magnataur"
    else if (heroName == "io") return "wisp"
    else if (heroName == "necrophos") return "necrolyte"
    else if (heroName == "outworld-destroyer") return "obsidian_destroyer"
    else if (heroName == "shadow-fiend") return "nevermore"
    else if (heroName == "timbersaw") return "shredder"
    else if (heroName == "treant-protector") return "treant"
    else if (heroName == "underlord") return "abyssal_underlord"
    else if (heroName == "queen-of-pain") return "queenofpain"
    else if (heroName == "vengeful-spirit") return "vengefulspirit"
    else if (heroName == "windranger") return "windrunner"
    else if (heroName == "wraith-king") return "skeleton_king"
    else if (heroName == "zeus") return "zuus"
    else return heroName.replaceAll("-","_")
  }

  function searchHero(heroName) {
    if (heroName.includes(queryText)) return true
    if ((heroName.split("-").reduce((x1,x2) => x1.charAt(0) + x2.charAt(0))).includes(queryText)) {
      // hero initials
      return true
    }
    return false
  }
  var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
  };
  getJSON('https://raw.githubusercontent.com/anhTimeLimitExceeded/dotabuff-picker/master/heroes.json', function(err, data) {
    heroes_json = {...data}
    heroes_json["anti-mage"]['avatar'] = `https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota_react/heroes/antimage.png`;
    for (hero in heroes_json) {
      heroes_json[hero]['avatar'] = `https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota_react/heroes/${getHeroName(hero)}.png`;
    }
    setInput(() => {
      search = "";
    })
  });

  // Event listeners

  document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener('keydown', function (e) {
      keyPressed = e.key
      if (keyPressed === 'Enter') {
        buttons = document.getElementById("heroes")
        if (buttons.childNodes.length >= 1) {
          buttons.firstChild.click()
        }
      } else if (keyPressed === 'Escape') {
        // clear_button = document.getElementById("clear")
        // clear_button.click()
        setInput(() => {
          queryText = ""
        })
      } else if (keyPressed === "Backspace") {
        setInput(() => {
          queryText = query.innerText.slice(0, -1)
        })
      } else if (keyPressed.length === 1) {
        setInput(() => {
          queryText += keyPressed
        })
      }
    });
    document.getElementById("clear").onclick = function(e) {
      setState(() => {
        enemies = []
      })
    };  
  });

  // State functions

  function setState(callback) {
    callback()
    renderEnemiesDOM()
    renderSpreadsheetDOM()
  }
  function setInput(callback) {
    callback()
    query = document.getElementById("query")
    query.innerText = queryText
    renderButtons()
  }

  // Rendering Functions

  function renderButtons() { // Filter buttons based on query
    buttons = document.getElementById("heroes")
    buttons.innerHTML = ''
    Object.keys(heroes_json).forEach(function(hero){
      if (searchHero(hero)) {
        button = document.createElement("button")
        button.innerHTML = hero;
        button.onclick = function(e) {
          setInput(() => {
            queryText = "";
          })
          setState(() => {
            enemies.push(e.target.innerHTML)
          })
        };
        buttons.appendChild(button)
      }
    });
  }
  function renderEnemiesDOM() { // Render selected enemies
    enemiesDOM = document.getElementById("enemies")
    enemiesDOM.innerHTML = ''
    enemies.forEach(function(x){
      button = document.createElement("button")
      button.innerHTML = x;
      button.onclick = function(e){
        const index = enemies.indexOf(e.target.innerHTML);
        if (index > -1) { 
          setState(() => {
            enemies.splice(index, 1);
          })
        }
      };
      enemiesDOM.appendChild(button)
    });
  }
  function renderSpreadsheetDOM() { // Render picking spreadsheet
    spreadsheetDOM = document.getElementById("spreadsheet")
    spreadsheetDOM.innerHTML = ''
    if (enemies.length == 0) {
      return;
    }
    columns = document.createElement("tr")
    columns.id = "columns-names"
    columns.appendChild(document.createElement("th"))
    enemies.forEach(function(enemy){
      column = document.createElement("th")
      img = document.createElement("img")
      img.src = heroes_json[enemy]['avatar']
      img.onclick = function(e) {
        const index = enemies.indexOf(enemy);
        if (index > -1) { 
          setState(() => {
            enemies.splice(index, 1);
          })
        }
      };
      enemy_name = document.createElement("span")
      enemy_name.innerHTML = enemy
      column.appendChild(img)
      column.appendChild(document.createElement("br"))
      column.appendChild(enemy_name)
      columns.appendChild(column)
    })
    total_column = document.createElement("th")
    total_column.innerHTML = "total"
    columns.appendChild(total_column)
    spreadsheetDOM.appendChild(columns)
    spreadsheetRows = []
    Object.keys(heroes_json).forEach(function(hero) {
      if (enemies.indexOf(hero) == -1) {
        row = []
        row.push(hero)
        let total_score = 0
        for (let i = 0; i < enemies.length; i++) {
          score = heroes_json[enemies[i]]['counters'][hero]    
          if (score.endsWith("%")) score = score.substring(0, score.length-1);
          row.push(score)
          total_score += parseFloat(score)
          total_score = Math.round(total_score * 1000) / 1000
        }
        row.push(total_score)
        spreadsheetRows.push(row)
      }
    })
    spreadsheetRows.sort(function(a, b){return parseFloat(b[a.length-1]) - parseFloat(a[a.length-1])});
    spreadsheetRows = spreadsheetRows.slice(0, 30) // limit to 30 results
    spreadsheetRows.forEach(function(row) {
      rowDOM = document.createElement("tr")
      for (let i = 0; i < row.length; i++) {
        dataCell = document.createElement("td")
        if (i == 0) { // display hero name 
          let hero_name = row[i]
          img = document.createElement("img")
          img.src = heroes_json[hero_name]['avatar']
          pick_name = document.createElement("span")
          pick_name.innerHTML = row[i]
          dataCell.appendChild(img)
          dataCell.appendChild(document.createElement("br"))
          dataCell.appendChild(pick_name)
        }

        if (i != 0) { // display scores
          dataCell.innerHTML = row[i]
          dataCell.innerHTML = row[i]
        }
        if (i != 0) {
          if (row[i] < 0) dataCell.style.color = 'red';
          else dataCell.style.color = 'green';
        }
        rowDOM.appendChild(dataCell)
      }
      spreadsheetDOM.appendChild(rowDOM)
    })
  }
</script>
<style>
  * {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
  }
  table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    text-align: center;
  }
  th, td {
	  padding: 4px;
  }
  img {
    max-width:100px;
    height:auto;
  }
  </style>
</head>
<body>
<h2>Picker <button id="clear">clear</button></h2>
<h3>Query: <span id="query"></span></h4>
<div id="heroes"></div>
<h2>Enemy team</h2>
<div id="enemies"></div>
<table id="spreadsheet">
</table>
</body>
</html>